services:
  # Signal CLI REST API with plugin enabled
  signal-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-api-test
    environment:
      - MODE=json-rpc
      - ENABLE_PLUGINS=true
    ports:
      - "8080:8080"
    volumes:
      - ../../plugins:/plugins
      - ./test-data:/home/.local/share/signal-cli
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/v1/about || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - test-network

  # Test runner with BATS
  test-runner:
    image: bats/bats:latest
    container_name: test-runner
    depends_on:
      signal-api:
        condition: service_healthy
    volumes:
      - ../helpers:/tests/helpers:ro
      - .:/tests/integration:ro
    environment:
      - API_URL=http://signal-api:8080
      - SENDER_NUMBER=+1234567890
      - RECIPIENT=+0987654321
    working_dir: /tests
    command: ["bats", "integration/richmessage.bats"]
    networks:
      - test-network

networks:
  test-network:
    driver: bridge